<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss TLM3D Route Planner (Debug Interface)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 350px; background: white; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
        .map-container { flex: 1; }
        #map { height: 100%; width: 100%; }
        .control-panel { padding: 15px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px; }
        h3, h4 { margin-top: 0; }
        .btn { display: block; width: 100%; background: #007bff; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .coordinates { font-family: monospace; font-size: 12px; color: #666; padding: 5px 0; }
        .status { padding: 10px; margin-top: 15px; border-radius: 4px; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .route-info { background: #e9ecef; padding: 15px; border-radius: 4px; margin-top: 15px; display: none; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>üìç Route Planner</h3>
        <p>Use the layer control in the top right of the map to change base maps and toggle overlays.</p>

        <div class="control-panel">
            <h4>Points</h4>
            <div>Start: <span class="coordinates" id="start-coords">Not set</span></div>
            <div>End: <span class="coordinates" id="end-coords">Not set</span></div>
        </div>

        <div class="control-panel">
            <h4>Network</h4>
            <label><input type="radio" name="network-type" value="ski_touring" checked> üéø Ski Touring (Available)</label><br>
            <label><input type="radio" name="network-type" value="tlm3d" disabled> üöó TLM3D (Not Available Yet)</label>
            <small style="color: #666; display: block; margin-top: 5px;">TLM3D routing will be available after preprocessing the road network data.</small>
        </div>

        <div class="control-panel">
            <label for="buffer-slider">Buffer: <span id="buffer-value">5.0</span> km</label>
            <input type="range" id="buffer-slider" min="0.5" max="20" step="0.1" value="5">
        </div>
        
        <button class="btn" id="calculate-btn" onclick="calculateRoute()" disabled>Calculate Route</button>
        <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>Calculating...</div>
        </div>
        
        <div id="status-container"></div>
        
        <div id="route-info" class="route-info">
            <h4>üìä Route Info</h4>
            <div><strong>Distance:</strong> <span id="route-length">-</span> km</div>
            <div><strong>Segments Loaded:</strong> <span id="segments-loaded">-</span></div>
            <div><strong>Buffer Used:</strong> <span id="buffer-size">-</span> km</div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-tilelayer-swiss@2.3.0/dist/Leaflet.TileLayer.Swiss.umd.js"></script>
    
    <script>
        // --- Global State ---
        let map;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;
        let startPoint = null;
        let endPoint = null;

        // --- Map Initialization ---
        function initMap() {
            // --- 1. Define Base Map Layers ---
            const swissWinter = L.tileLayer.swiss({ layer: 'ch.swisstopo.pixelkarte-farbe-winter' });
            const swissColor = L.tileLayer.swiss({ layer: 'ch.swisstopo.pixelkarte-farbe' });
            const swissGrey = L.tileLayer.swiss({ layer: 'ch.swisstopo.pixelkarte-grau' });

            // --- 2. Define Overlay Layers ---
            const slopeAngles = L.tileLayer.swiss({
                layer: 'ch.swisstopo.hangneigung-ueber_30',
                format: 'png',
                opacity: 0.5
            });

            const hikingTrails = L.tileLayer.swiss({
                layer: 'ch.swisstopo.swisstlm3d-wanderwege',
                format: 'png',
                opacity: 0.8
            });
            
            // --- NEW: Add the official ski touring routes overlay ---
            const skiTouringRoutes = L.tileLayer.swiss({
                layer: 'ch.swisstopo-karto.skitouren', // Layer name for official ski routes
                format: 'png',
                opacity: 0.8
            });

            // --- 3. Create the map with a default base layer ---
            map = L.map('map', {
                crs: L.CRS.EPSG2056,
                layers: [swissWinter]
            });
            map.fitSwitzerland();
            map.on('click', onMapClick);

            // --- 4. Create Layer Control Objects ---
            const baseMaps = {
                "Winter Map": swissWinter,
                "Color Map": swissColor,
                "Grey Map": swissGrey
            };

            const overlayMaps = {
                "Slope > 30¬∞": slopeAngles,
                "Marked Trails": hikingTrails,
                "Official Ski Routes": skiTouringRoutes // Add new layer to the control
            };

            // --- 5. Add the Layer Control to the map ---
            L.control.layers(baseMaps, overlayMaps).addTo(map);
            
            // --- 6. Add event listener for buffer slider ---
            document.getElementById('buffer-slider').addEventListener('input', (e) => {
                document.getElementById('buffer-value').textContent = parseFloat(e.target.value).toFixed(1);
            });
        }

        // --- User Interaction ---
        function onMapClick(e) {
            if (!startPoint) {
                setPoint('start', e.latlng);
            } else if (!endPoint) {
                setPoint('end', e.latlng);
            }
        }
        
        function setPoint(type, latlng) {
            const marker = L.marker(latlng, { draggable: true }).addTo(map);
            if (type === 'start') {
                startPoint = latlng;
                startMarker = marker;
                marker.on('dragend', (e) => { startPoint = e.target.getLatLng(); updateCoordsDisplay(); });
            } else {
                endPoint = latlng;
                endMarker = marker;
                marker.on('dragend', (e) => { endPoint = e.target.getLatLng(); updateCoordsDisplay(); });
            }
            updateCoordsDisplay();
            updateCalculateButton();
        }
        
        // --- Backend Communication ---
        async function calculateRoute() {
            if (!startPoint || !endPoint) return;
            showLoading(true);
            clearRoute();
            try {
                const networkType = document.querySelector('input[name="network-type"]:checked').value;
                const bufferDistance = parseFloat(document.getElementById('buffer-slider').value) * 1000;
                const response = await fetch('/calculate_route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_coords: [startPoint.lat, startPoint.lng],
                        end_coords: [endPoint.lat, endPoint.lng],
                        buffer_distance: bufferDistance,
                        network_type: networkType
                    })
                });
                const result = await response.json();
                if (result.success && result.route) {
                    displayRoute(result);
                    showStatus('Route calculated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'No route found.');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- UI Updates & Display ---
        function displayRoute(result) {
            const routeLatLngs = result.route.map(coord => {
                const point = map.options.crs.projection.unproject({ x: coord[0], y: coord[1] });
                return [point.lat, point.lng];
            });
            routeLayer = L.layerGroup().addTo(map);
            L.polyline(routeLatLngs, { color: 'white', weight: 8, opacity: 0.8 }).addTo(routeLayer);
            L.polyline(routeLatLngs, { color: '#ff6600', weight: 5 }).addTo(routeLayer);
            map.fitBounds(L.polyline(routeLatLngs).getBounds(), { padding: [50, 50] });
            document.getElementById('route-info').style.display = 'block';
            document.getElementById('route-length').textContent = (result.path_length / 1000).toFixed(2);
            document.getElementById('segments-loaded').textContent = result.segments_loaded;
            document.getElementById('buffer-size').textContent = (result.buffer_distance / 1000).toFixed(1);
        }

        function clearAll() {
            clearRoute();
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
            startPoint = null;
            endPoint = null;
            updateCoordsDisplay();
            updateCalculateButton();
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('status-container').innerHTML = '';
        }

        function clearRoute() {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
        }

        function updateCoordsDisplay() {
            document.getElementById('start-coords').textContent = startPoint ? `${startPoint.lat.toFixed(5)}, ${startPoint.lng.toFixed(5)}` : 'Not set';
            document.getElementById('end-coords').textContent = endPoint ? `${endPoint.lat.toFixed(5)}, ${endPoint.lng.toFixed(5)}` : 'Not set';
        }

        function updateCalculateButton() {
            document.getElementById('calculate-btn').disabled = !(startPoint && endPoint);
        }
        
        function showStatus(message, type = 'info') {
            document.getElementById('status-container').innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>